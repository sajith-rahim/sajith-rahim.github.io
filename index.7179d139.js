THREE=THREE||window.THREE,THREE.OBJLoader=window.OBJLoader;class t{init(){this.group=new THREE.Object3D,this.bgColor=window.getComputedStyle(document.body,null).getPropertyValue("background-color"),this.gridSize=40,this.hornet,this._tracker={x:0,y:0,z:0,ftb:!0},this.buildings=[],this.raycaster=new THREE.Raycaster,this.fogConfig={color:"#353c3c",near:1,far:208},this.width=window.innerWidth,this.height=window.innerHeight,this.lightColor=model.tracker.worldSystem.currentStar||"#d3263a",this.createScene(),this.createCamera(),this.addCameraControls(),this.addFloor(),this.addBackgroundShape(),this.loadModels("./assets/models/riverworld_portal_tower_unsc50.obj",this.onLoadModelsComplete.bind(this)),this.createLabelRenderer(),this.animate(),this.setLights(),window.addEventListener("click",(t=>this.doRaycastIntersect(t))),window.addEventListener("starChange",(t=>this.updatePointLight(t))),window.addEventListener("perspectiveChange",(t=>this.handlePerspectiveChange(t)))}setLights(){this.pointLightObj3={color:this.lightColor,intensity:18.2,position:{x:16,y:100,z:-68}},this.addPointLight(this.pointLightObj3),this.pointLightObj4={color:this.lightColor,intensity:8.2,position:{x:16,y:150,z:128}},this.addPointLight(this.pointLightObj4)}createScene(){this.scene=new THREE.Scene,this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),this.renderer.setSize(this.width,this.height),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap,document.body.querySelector(".canvas-wrapper").appendChild(this.renderer.domElement),this.scene.fog=new THREE.Fog(this.fogConfig.color,this.fogConfig.near,this.fogConfig.far)}createCamera(){this.camera=new THREE.PerspectiveCamera(65,this.width/this.height,1,-500),this.camera.position.set(0,0,0),this.scene.add(this.camera)}createLabelRenderer(){this._2DRenderer=new THREE.CSS2DRenderer,this._2DRenderer.setSize(this.width,this.height),this._2DRenderer.domElement.style.position="fixed",this._2DRenderer.domElement.style.top="0px",document.body.appendChild(this._2DRenderer.domElement)}addLabel(t,e){if(1===model.$refs.frame.classList.length)return;let i=document.createElement("div");i.setAttribute("id","label-element"),i.innerHTML=e;let s=document.createElement("div");s.setAttribute("id","label-wrapper"),s.appendChild(i);const o=new THREE.CSS2DObject(s);this.scene.add(o),o.position.set(t.x,t.y,t.z),model.$refs.frame.classList.remove("frame-z"),setTimeout((()=>{this.scene.remove(o),model.$refs.frame.classList.add("frame-z")}),6e3)}addCameraControls(){this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement),this.controls.enabled=!1}addSpotLight(){const t="#ff0000",e=641,i=-462,s=509,o=new THREE.SpotLight(t,1);o.position.set(e,i,s),o.castShadow=!0,this.scene.add(o)}addAmbientLight(){const t=new THREE.AmbientLight("#a00a0a");this.scene.add(t)}addBackgroundShape(){const t=new THREE.PlaneGeometry(400,100),e=new THREE.MeshPhysicalMaterial({color:"#fff"});this.backgroundShape=new THREE.Mesh(t,e),this.backgroundShape.position.y=10,this.backgroundShape.position.z=-150,this.scene.add(this.backgroundShape),this.mouseX=3,this.lastMouseX=3,this.lastMouseY=65,this.lastScale=155,this.tiltFx={body:document.body,docEl:document.documentElement,getMousePos:(t,e)=>{let i=0,s=0;return t||(t=window.event),t.pageX||t.pageY?(i=t.pageX,s=t.pageY):(t.clientX||t.clientY)&&(i=t.clientX+e.left,s=t.clientY+e.top),{x:i,y:s}},lerp:(t,e,i)=>(1-i)*t+i*e,lineEq:(t,e,i,s,o)=>{let n=(t-e)/(i-s);return n*o+(e-n*s)}},this.docheight=Math.max(this.tiltFx.body.scrollHeight,this.tiltFx.body.offsetHeight,this.tiltFx.docEl.clientHeight,this.tiltFx.docEl.scrollHeight,this.tiltFx.docEl.offsetHeight),this.requestId=requestAnimationFrame((()=>this.tilt())),window.addEventListener("mousemove",(t=>{const e={left:this.tiltFx.body.scrollLeft+this.tiltFx.docEl.scrollLeft,top:this.tiltFx.body.scrollTop+this.tiltFx.docEl.scrollTop},i=this.tiltFx.getMousePos(t,e);this.mouseX=i.x-e.left})),window.addEventListener("resize",(()=>this.docheight=Math.max(this.tiltFx.body.scrollHeight,this.tiltFx.body.offsetHeight,this.tiltFx.docEl.clientHeight,this.tiltFx.docEl.scrollHeight,this.tiltFx.docEl.offsetHeight))),window.onbeforeunload=()=>{window.cancelAnimationFrame(this.requestId),window.scrollTo(0,0)}}tilt(){this.lastMouseX=this.tiltFx.lerp(this.lastMouseX,this.tiltFx.lineEq(40,-35,this.width,0,this.mouseX),.05);const t=window.pageYOffset;this.lastMouseY=this.tiltFx.lerp(this.lastMouseY,this.tiltFx.lineEq(0,65,this.docheight,0,t),.05),this.lastScale=this.tiltFx.lerp(this.lastScale,this.tiltFx.lineEq(-178,158,this.docheight,0,t),.05),this.camera.position.set(this.lastMouseX,this.lastMouseY,this.lastScale),this.requestId=requestAnimationFrame((()=>this.tilt())),this.driveHornet(Number(this.camera.position.x).toFixed(1),Number(this.camera.position.y).toFixed(0)),this._tracker={x:this.lastMouseX,y:this.lastMouseY,z:this.lastScale,ftb:this._tracker.z>this.lastScale};const e=new CustomEvent("track",{detail:{z:Number.parseInt(this.camera.position.z)}});window.dispatchEvent(e)}addFloor(){const t=new THREE.PlaneGeometry(200,200),e=new THREE.MeshStandardMaterial({color:"#000000",metalness:0,emissive:"#000000",roughness:0}),i=new THREE.Mesh(t,e);t.rotateX(-Math.PI/2),i.position.y=0,this.scene.add(i)}addPointLight(t){const e=new THREE.PointLight(t.color,t.intensity);e.position.set(t.position.x,t.position.y,t.position.z),this.scene.add(e)}updatePointLight(t){t.detail&&this.scene.children.filter((t=>t.isLight)).map((e=>e.color.set(new THREE.Color(t.detail.color))))}getRandomBuiding(){return this.models[Math.floor(Math.random()*Math.floor(this.models.length))]}onLoadModelsComplete(t){this.models=[...t.children].map((t=>{const e=.75;return t.scale.set(e,e,e),t.position.set(-90,-300,-130),t.receiveShadow=!0,t.castShadow=!0,t})),this.draw(),setTimeout((()=>{this.showObjects()}),500),window.addEventListener("resize",this.onResize.bind(this))}removeLoader(){model.state.enviromentMapLoaded=!0,model.$refs.bg_canvas_loader.classList.add("loader--done")}showObjects(){this.sortObjectsByDistance(),this.buildings.forEach(((t,e)=>{TweenMax.to(t.position,.6+e/4e3,{y:1,ease:Quint.easeOut,delay:e/4e3})})),this.removeLoader()}sortObjectsByDistance(){this.buildings.sort(((t,e)=>t.position.z>e.position.z?1:t.position.z<e.position.z?-1:0)).reverse()}loadModels(t,e){(new THREE.OBJLoader).load(t,e)}draw(){const t=new THREE.MeshPhysicalMaterial({color:"#000",metalness:0,emissive:"#000",roughness:.77});for(let e=0;e<this.gridSize;e++)for(let e=0;e<this.gridSize;e++){const e=this.getRandomBuiding().clone();e.material=t,e.scale.y=.55,["mmGroup311","mmGroup307","mmGroup303","mmGroup299"].includes(e.name)&&(e.material=t.clone(),e.material.color.setHex(30464),e.scale.y=1),["mmGroup313","mmGroup309","mmGroup305","mmGroup301"].includes(e.name)&&(e.material=t.clone(),e.material.color.setHex(30464)),this.group.add(e),this.buildings.push(e)}this.scene.add(this.group),this.group.position.set(-this.gridSize-10,1,-this.gridSize-10)}onResize(){this.width=window.innerWidth,this.height=window.innerHeight,this.camera.aspect=this.width/this.height,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.width,this.height),this._2DRenderer.setSize(this.width,this.height)}animate(){this.controls.update(),this.renderer.render(this.scene,this.camera),this._2DRenderer.render(this.scene,this.camera),requestAnimationFrame(this.animate.bind(this))}doRaycastIntersect(t,e=!1){const i={mmGroup313:"about",mmGroup309:"projects",mmGroup305:"activeMissions",mmGroup301:"connect"};var s={};e?(s.x=t.changedTouches[0].clientX/window.innerWidth*2-1,s.y=1-t.changedTouches[0].clientY/window.innerHeight*2):(s.x=t.clientX/window.innerWidth*2-1,s.y=1-t.clientY/window.innerHeight*2),this.raycaster.setFromCamera(s,this.camera);var o=this.raycaster.intersectObjects(this.scene.children,!0);if(o[0]){var n=o[0].object;["mmGroup313","mmGroup309","mmGroup305","mmGroup301"].includes(n.name)&&this.addLabel(o[0].point,model.getModelInfo(i[n.name]))}}getHornetPitchForward(t){return t<60&&t>45?Math.abs(54-t)+-45:t<44&&t>26?15:t<16&&t>12?Math.abs(t)/3+0:-15}getHornetPitchBackward(t){return t<60&&t>50?t/20:t<44&&t>26?15:t<21&&t>12?Math.abs(15-t)+-45:-15}driveHornet(t,e){this.hornet&&(this._tracker.ftb?this.hornet.rotation.z=THREE.MathUtils.degToRad(this.getHornetPitchForward(e)):this.hornet.rotation.z=THREE.MathUtils.degToRad(this.getHornetPitchBackward(e)),this.hornet.rotation.y=THREE.MathUtils.degToRad(.1*t+90))}handlePerspectiveChange(t){if("3PV"===t.detail.view)try{this.loadHornet()}catch(t){}else try{this.camera.remove(this.hornet),this.hornet=void 0}catch(t){}}loadHornet(){(new THREE.OBJLoader).load("./assets/models/hornet.obj",function(t){t&&(this.hornet=t,this.camera.add(t),this.hornet.position.set(0,0,-10),t.scale.set(.6,.6,.6),this.hornet.rotation.set(.69,1.57079,-.26178),this.hornet.children.map((t=>t.material.color.setHex(36351))))}.bind(this))}}window.addEventListener("load",(()=>{const e=new t;e.init(),window.app=e})),window.loadH=function(){(new THREE.OBJLoader).load("./assets/models/hornet.obj",(function(t){window.hornet=t}))};